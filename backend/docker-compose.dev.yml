# Development override for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  backend:
    build:
      target: development
    volumes:
      - ./services/backend:/app:cached
    environment:
      - DEBUG=true
      - API_RELOAD=true
    command: ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    ports:
      - "8000:8000"

  celery-worker:
    build:
      target: development
    volumes:
      - ./services/backend:/app:cached
    environment:
      - DEBUG=true
    command: ["celery", "-A", "app.celery", "worker", "--loglevel=debug", "--concurrency=2"]

  celery-beat:
    build:
      target: development  
    volumes:
      - ./services/backend:/app:cached
    environment:
      - DEBUG=true

  postgres:
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_LOG_STATEMENT=all
      - POSTGRES_LOG_MIN_DURATION_STATEMENT=0

  redis:
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-dev_redis_123} --loglevel debug

  geoserver:
    ports:
      - "8082:8080"
    environment:
      - GEOSERVER_LOG_LEVEL=DEBUG

  # Add a development database browser (ARM64 compatible)
  pgadmin:
    image: dpage/pgadmin4:8.13
    container_name: estation_pgadmin
    restart: unless-stopped
    platform: linux/arm64
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@estation.dev
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    networks:
      - estation_network
    depends_on:
      - postgres

  # Add Redis browser for development (ARM64 compatible)
  redis-commander:
    image: ghcr.io/joeferner/redis-commander:latest
    container_name: estation_redis_commander
    restart: unless-stopped
    platform: linux/arm64
    environment:
      - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD:-dev_redis_123}
    ports:
      - "8081:8081"
    networks:
      - estation_network
    depends_on:
      - redis